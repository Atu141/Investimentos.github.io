<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Investimentos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">Calculadora de Investimentos</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="aporteInicial" class="block text-sm font-medium text-gray-700">Aporte inicial (R$)</label>
        <input type="number" id="aporteInicial" class="border rounded-xl p-2 w-full" value="0" />
      </div>
      <div>
        <label for="aporte" class="block text-sm font-medium text-gray-700">Aporte mensal (R$)</label>
        <input type="number" id="aporte" class="border rounded-xl p-2 w-full" value="100" />
      </div>
      <div>
        <label for="taxa" class="block text-sm font-medium text-gray-700">Taxa de juros anual (%)</label>
        <input type="number" id="taxa" class="border rounded-xl p-2 w-full" value="10" />
      </div>
      <div>
        <label for="periodo" class="block text-sm font-medium text-gray-700">Per칤odo (meses)</label>
        <input type="number" id="periodo" class="border rounded-xl p-2 w-full" value="12" />
      </div>
      <div>
        <label for="inflacao" class="block text-sm font-medium text-gray-700">Infla칞칚o mensal (%)</label>
        <input type="number" step="0.01" id="inflacao" value="0" class="border rounded-xl p-2 w-full" />
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-4">
      <button onclick="simular()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl">Simular</button>
      <button onclick="adicionarCenario()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl">Adicionar Cen치rio</button>
      <button onclick="exportarPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl">Exportar PDF</button>
    </div>

    <div class="mt-6" id="resultado"></div>

    <div class="mt-4 flex justify-end">
      <label class="mr-2 font-medium text-gray-700">Tipo de Gr치fico:</label>
      <select id="tipoGrafico" onchange="compararCenarios()" class="border rounded-xl p-2">
        <option value="line">Linha</option>
        <option value="bar">Barra</option>
        <option value="pie">Pizza</option>
        <option value="radar">Radar</option>
      </select>
    </div>

    <canvas id="grafico" class="mt-6"></canvas>
  </div>

  <script>
    let cenarios = [];
    let grafico;

    async function carregarInflacaoAtual() {
      const url = "https://api.bcb.gov.br/dados/serie/bcdata.sgs.433/dados/ultimos/1?formato=json";
      try {
        const resposta = await fetch(url);
        const dados = await resposta.json();
        const inflacao = parseFloat(dados[0].valor.replace(",", ".")) / 100;
        document.getElementById("inflacao").value = (inflacao * 100).toFixed(2);
      } catch (erro) {
        console.error("Erro ao buscar infla칞칚o do BACEN:", erro);
      }
    }

    document.addEventListener("DOMContentLoaded", () => carregarInflacaoAtual());

    function formatarBRL(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    function simular() {
      cenarios = [];
      adicionarCenario();
    }

    function adicionarCenario() {
      const aporteInicial = parseFloat(document.getElementById("aporteInicial").value || 0);
      const aporte = parseFloat(document.getElementById("aporte").value || 0);
      const taxaAnual = parseFloat(document.getElementById("taxa").value || 0);
      const periodo = parseInt(document.getElementById("periodo").value || 0);
      const inflacaoMensal = parseFloat(document.getElementById("inflacao").value || 0) / 100;

      const taxaMensal = Math.pow(1 + taxaAnual / 100, 1 / 12) - 1;
      const taxaReal = ((1 + taxaMensal) / (1 + inflacaoMensal)) - 1;

      let montante = aporteInicial;
      let investido = aporteInicial;
      let dados = [montante];

      for (let i = 1; i <= periodo; i++) {
        montante = montante * (1 + taxaReal) + aporte;
        investido += aporte;
        dados.push(montante);
      }

      const juros = montante - investido;
      let ir = 0;
      if (periodo < 6) ir = juros * 0.225;
      else if (periodo < 12) ir = juros * 0.20;
      else if (periodo < 24) ir = juros * 0.175;
      else ir = juros * 0.15;

      const resultado = {
        montante,
        investido,
        juros,
        ir,
        dados
      };

      cenarios.push(resultado);
      exibirResultados();
      compararCenarios();
    }

    function exibirResultados() {
      const html = cenarios.map((r, i) => `
        <div class="bg-gray-100 p-4 rounded-xl">
          <h3 class="font-semibold mb-2">Cen치rio ${i + 1}</h3>
          <p>游눺 <strong>Montante:</strong> ${formatarBRL(r.montante)}</p>
          <p>游눯 <strong>Investido:</strong> ${formatarBRL(r.investido)}</p>
          <p>游늳 <strong>Juros:</strong> ${formatarBRL(r.juros)}</p>
          ${r.ir > 0 ? `<p>游눶 <strong>IR:</strong> ${formatarBRL(r.ir)}</p>` : ''}
        </div>
      `).join('');
      document.getElementById("resultado").innerHTML = html;
    }

    function compararCenarios() {
      const tipo = document.getElementById("tipoGrafico").value;
      const ctx = document.getElementById("grafico").getContext("2d");
      if (grafico) grafico.destroy();

      if (tipo === 'pie') {
        grafico = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: cenarios.map((_, i) => `Cen치rio ${i + 1}`),
            datasets: [{
              label: 'Montante Final',
              data: cenarios.map(c => c.montante),
              backgroundColor: ['#2563eb', '#16a34a', '#facc15', '#ec4899']
            }]
          },
          options: {
            responsive: true
          }
        });
      } else {
        const labels = Array.from({ length: Math.max(...cenarios.map(c => c.dados.length)) }, (_, i) => `${i}췈 m칡s`);
        grafico = new Chart(ctx, {
          type: tipo,
          data: {
            labels,
            datasets: cenarios.map((c, i) => ({
              label: `Cen치rio ${i + 1}`,
              data: c.dados,
              borderColor: ['#2563eb', '#16a34a', '#facc15', '#ec4899'][i % 4],
              backgroundColor: ['#2563eb33', '#16a34a33', '#facc1533', '#ec489933'][i % 4],
              fill: tipo !== 'radar',
              tension: 0.3
            }))
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: { mode: 'index', intersect: false }
            },
            interaction: { mode: 'index', intersect: false },
            scales: tipo !== 'radar' && tipo !== 'pie' ? {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => formatarBRL(value)
                }
              }
            } : {}
          }
        });
      }
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(16);
      pdf.text("Simula칞칚o de Investimentos", 10, 10);
      cenarios.forEach((c, i) => {
        const offset = 20 + i * 30;
        pdf.setFontSize(12);
        pdf.text(`Cen치rio ${i + 1}`, 10, offset);
        pdf.text(`Montante: ${formatarBRL(c.montante)}`, 10, offset + 6);
        pdf.text(`Investido: ${formatarBRL(c.investido)}`, 10, offset + 12);
        pdf.text(`Juros: ${formatarBRL(c.juros)}`, 10, offset + 18);
        if (c.ir > 0) pdf.text(`IR: ${formatarBRL(c.ir)}`, 10, offset + 24);
      });

      html2canvas(document.getElementById("grafico")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 10, 10, 180, 100);
        pdf.save("simulacao-investimentos.pdf");
      });
    }
  </script>
</body>
</html>
